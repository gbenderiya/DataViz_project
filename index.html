<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta viewport="width=device-width, initial-scale=1.0">
  <title>Map Zoom</title>
  <style>
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    
    .popup {
      position: absolute;
      background-color: white;
      border: 1px solid #ccc;
      padding: 10px;
      z-index: 1000;
      display: none;
    }
    .county {
      fill: #6ECF68;
      stroke: #444;
      stroke-width: 0.5;
      transition: fill 0.75s ease-in-out;
    }
    .highlighted {
      fill: #F2D729;
    }
    .state {
      fill: none;
      stroke: #444;
    }
    #zoomOutButton {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 10px 20px;
      cursor: pointer;
      z-index: 1;
    }
  </style>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://unpkg.com/topojson-client@3"></script>
</head>
<body>
  <button id="zoomOutButton">Zoom Out</button> <!-- Button to trigger zooming out -->
  <svg id="map" width="975" height="610"></svg>
  <div id="popup" class="popup"></div>

  <script>
    const svg = d3.select("#map"),
          width = +svg.attr("width"),
          height = +svg.attr("height"),
          popup = d3.select("#popup");
          zoomOutButton = document.getElementById("zoomOutButton");
    
    // D3 zoom function
    const zoom = d3.zoom()
      .scaleExtent([1, 8])
      .on("zoom", (event) => svg.selectAll("path").attr("transform", event.transform));

    svg.call(zoom);

    // Event listener to the zoom out button to reset the zoom
    zoomOutButton.addEventListener("click", function() {
      svg.transition().duration(750).call(zoom.transform, d3.zoomIdentity); // Reset zoom
      svg.selectAll(".county").classed("highlighted", false);
      popup.style("display", "none");
    });

    // Load the data
    d3.json("counties-albers-10m.json").then(us => {
      const path = d3.geoPath();

      // Bind counties data to paths
      const counties = svg.selectAll(".county")
        .data(topojson.feature(us, us.objects.counties).features)
        .enter().append("path")
          .attr("class", "county")
          .attr("d", path)
          .each(function(d) { // title for hover tooltip
            d3.select(this).append("title").text(d => `State: ${d.properties.state}\nCounty: ${d.properties.name}`);
          });
      
      // Bind states data to paths
      svg.selectAll(".state")
        .data(topojson.feature(us, us.objects.states).features)
        .enter().append("path")
          .attr("class", "state")
          .attr("d", path);
      
      // Add click event to counties for zooming and highlighting
      counties.on("click", (event, d) => {
        zoomToFeature(d, path);
        svg.selectAll(".county").classed("highlighted", false);
        d3.select(event.currentTarget).classed("highlighted", true);
        popup.style("display", "none"); // hide the popup
        event.stopPropagation(); 
      });
      
      // Function to zoom into a feature (county/state)
      function zoomToFeature(feature, path) {
        const bounds = path.bounds(feature),
              dx = bounds[1][0] - bounds[0][0],
              dy = bounds[1][1] - bounds[0][1],
              x = (bounds[0][0] + bounds[1][0]) / 2,
              y = (bounds[0][1] + bounds[1][1]) / 2,
              scale = Math.max(1, Math.min(8, 0.9 / Math.max(dx / width, dy / height))),
              translate = [width / 2 - scale * x, height / 2 - scale * y];

        svg.transition().duration(750)
           .call(zoom.transform, d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale));
      }
    });
  </script>
</body>
</html>
